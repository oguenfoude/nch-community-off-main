// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// CLIENT MODEL - Profile only (payment moved to Payment model)
// ============================================
model Client {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Profile
  firstName         String
  lastName          String
  email             String   @unique
  phone             String
  wilaya            String
  diploma           String
  password          String   // Plain text for MVP
  
  // Subscription
  selectedOffer     String   // basic, premium, gold
  selectedCountries String[]
  
  // Documents
  documents         Json
  driveFolder       Json?
  
  // Status
  status            String   @default("pending")
  
  // Relations
  payments          Payment[]
  stages            ClientStage[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("clients")
}

// ============================================
// PAYMENT MODEL - Tracks all payments per client
// ============================================
model Payment {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relation to Client
  clientId          String   @db.ObjectId
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Payment details
  paymentType       String   // 'initial' or 'second'
  paymentMethod     String   // 'cib' or 'baridimob'
  amount            Float
  status            String   @default("pending") // pending, verified, failed
  
  // BaridiMob specific
  baridiMobInfo     Json?    // { fullName, wilaya, rip, ccp, key }
  receiptUrl        String?  // Cloudinary URL
  
  // SofizPay specific
  transactionId     String?
  sofizpayResponse  Json?
  
  // Admin verification
  verifiedBy        String?  @db.ObjectId
  verifiedAt        DateTime?
  rejectionReason   String?  // Reason if payment is rejected
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([clientId])
  @@map("payments")
}

// ============================================
// ADMIN MODEL
// ============================================
model Admin {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  email     String    @unique
  password  String
  name      String
  role      AdminRole @default(ADMIN)
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("admins")
}

// ============================================
// PENDING REGISTRATION - For CIB/BaridiMob awaiting completion
// ============================================
model PendingRegistration {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken     String   @unique
  
  // Client data stored as JSON until approved
  registrationData Json
  paymentDetails   Json?
  
  // Status: pending (card payment), pending_verification (baridimob), approved, rejected, expired
  status           String   @default("pending")
  rejectionReason  String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  expiresAt        DateTime?

  @@index([createdAt])
  @@index([status])
  @@map("pendingregistrations")
}

// ============================================
// CLIENT STAGE - Progress tracking
// ============================================
model ClientStage {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  clientId           String   @db.ObjectId
  stageNumber        Int
  stageName          String
  status             String   @default("not_started") // not_started, in_progress, pending_review, completed
  requiredDocuments  String[]
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  client             Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, stageNumber])
  @@map("client_stages")
}

// ============================================
// ENUMS
// ============================================
enum AdminRole {
  ADMIN
  SUPER_ADMIN
}